## Title：来谈谈 Mac OS X 内核
现在，我们所知道的操作系统中，都有一个关键的核心组件，叫做内核（kernel）。内核能够充分利用底层 CPU 提供的所有特性和能力，为客户提供各种各样的服务。

那么，内核到底为我们做了什么呢？

* 内核为我们应用程序开发者，做了层次的抽象，我们不需要过多考虑设备访问、文件读写，我们可以使用内核提供的一套 API 很快速的完成想要的功能
* 现在操作系统都是多任务抢占式的操作系统，程序的数目可以远多于处理器（核心）的数目，内核会判定哪一个程序运行在哪一个处理器上
* 程序会访问共享设备（显示器、网络适配器等），内核提供安全的调度方式，来规避冲突和瓶颈
* 内核也提供安全服务，对各种权限做验证

## 内核架构

####1.单内核

单内核，也叫宏内核，将所有的内核功能都放到一个地址空间中，线程调度和内存管理，以及文件系统、安全管理、设备驱动等都放在一起。

所有内核功能都实现在同一个地址空间中，宏内核只需要函数调用就可以完成各个功能的协调合作，具有简洁、性能好的特点。

￼![](http://p1.bqimg.com/567571/6e415fc1361d91de.jpg)

####2.微内核
微内核，只包含最核心的功能，通常包括任务调度和内存管理，其他功能都交给用户态的服务程序。所有这些服务，都被分解到不同的地址空间里，因此，不能够像单内核那样直接的函数调用，微内核各个服务程序之间需要通过消息传递（IPC）来进行通信。

微内核的进程通信需要内存复制、上下文切换等操作，同时消息传递也存在一些延迟，所以微内核的性能不及单内核。但是，微内核的拥护者，一直以微内核的灵活性、稳定性而骄傲。

####3.混合内核

混合内核想要结合以上两种内核的好处，最核心的底层服务，包括调度、进程通信和虚拟内存，和微内核一样，包含在最核心的位置，对于这个核心之外的服务，也是在内核态的，同时和这个核心在同一内存空间中。

我们 `Mac OS X` 系统的内核就是混合内核，我们叫它 `XNU `。`XNU `的核心是 `Mach`，同时在 `Mach `之上建立了一个` BSD `层 ，他们都在同一地址空间中，和单内核一样具有较高的运行效率。

![](http://p1.bqimg.com/567571/a5c6344497fa8136.jpg)
￼
注：`XNU `也有消息传递，但是消息以指针的形式传递，不需要昂贵的复制操作，所以与单内核一样具有高效率。

## XNU-Mach 

Mach 和 BSD 都有自己职责的分工，那么先说 Mach 都有那些核心的职责

* 进程和线程管理：我们平时所用到的 POSIX 线程和 NSThread 都是和 Mach 层线程一一对应的，POSIX 线程是BSD 层对 线程的更高层次抽象
* 虚拟内存的分配和管理
* CPU 等物理设备的分配和调度
* 异常：Mach 在已有的消息传递机制上实现了一种异常处理机制，下面会仔细介绍作为应用层面的开发者，如何来做 Mach 异常捕获，可以利用这个做一些 crash 信息的收集工作，其他 crash 收集文章可以[参考这里](https://github.com/joy0304/Joy-Blog/blob/master/%E5%AE%9E%E8%B7%B5%E6%B8%85%E5%8D%95%EF%BC%9A%E6%94%B6%E5%BD%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8D%9A%E6%96%87.md)

如果想要做` mach` 异常捕获，需要注册一个异常端口，这个异常端口会对当前任务的所有线程有效，如果想要针对单个线程，可以通过 `thread_set_exception_ports `注册自己的异常端口，发生异常时，首先会将异常抛给线程的异常端口，然后尝试抛给任务的异常端口，当我们捕获异常时，就可以做一些自己的工作，比如，当前堆栈收集等。

对于如何注册一个异常端口，这里有一个示意图和 [相关代码](https://github.com/joy0304/Joy-Blog/tree/master/Contents/MachExceptionDemo) 可以参考


![](http://p1.bqimg.com/567571/b19be90e6d7d5ab1.jpg)

￼
## XNU-BSD

Mach 层的服务不足以支撑整个完整的操作系统，在Mach 之上，又建立了一个 BSD 层，BSD 提供了更丰富的功能

* 进程和线程更多特性：BSD 层的 进程和线程比 Mach 层包含更多的信息，支持更多的特性，Mach 层的进程和线程并不能满足操作系统的高级需求，通过BSD 层 XNU 提供了更为丰富且标准化的 API
* 网络协议栈
* 文件系统：在 OS X 中可执行文件格式为 Mach-O，对于 Mach-O 的初级理解，可以先了解下 [趣探 Mach-O：文件格式](https://github.com/joy0304/Joy-Blog/blob/master/Blog/%E8%B6%A3%E6%8E%A2%20Mach-O%EF%BC%9A%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F.md)
* 设备访问

## libkern + I/O Kit

`libkern` 是一个自包含的 C++ 类库，为 C++ 运行时提供支持和基础类。` I/O Kit` 是一个 C++ 编写的设备程序驱动框架，让开发者可以快速的创建稳定优雅的设备驱动程序。

## OS X 与 iOS 区别

OS X 与 iOS 大致上保持一致，但是也有些区别

* iOS 上内存管理使用 `jetsam` 机制，一个基于优先级队列的机制，优先级由低到高是：`IDLE`（空闲）－>`BACKGROUND`－>`FOREGROUND`,依次类推。当内存过低的时候，就会在队列中进行广播，希望大家尽量释放内存，如果一段时间后，仍然内存不够，就会开始`Kill`进程，直到内存够用。但是` OS X `上使用的是` Swap `机制，利用内存和磁盘的交换来协调进程间内存使用。
* 沙盒化，所有通过`app store `分发的程序都会有沙盒化这一机制， OS X 可以通过多种渠道下载软件，但是 iOS 只能通过` app store` 下载， iOS 上所有软件必须都支持沙盒化。
* `entitlement`：是一个 plist 文件，里面列举了可以获得的授权，会由苹果进行数字签名。`entitlement `是用来赋予你某种权限，`apple` 可以通过` entitlement `来赋予开发者更多的权限。
* `encrypted image` ：程序 `image` 加密功能

## 参考资料

* [代码签名探析](https://objccn.io/issue-17-2/)
* Mac OS X and iOS Internals: To Apple Core
* iDev 开发者大会 - 李亮

